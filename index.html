<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Lebensmittel â€“ Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; background:#f4f6f9; padding:20px; }
.section {
  background:white;
  padding:20px;
  border-radius:10px;
  margin-bottom:25px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
input, select, button { padding:8px; margin:5px; }
button {
  background:#2f6fed;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:hover { background:#1f4fc4; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; }
</style>
</head>

<body>

<h1>ðŸ“Š Lebensmittel â€“ Dashboard</h1>

<!-- Suche -->
<div class="section">
<h3>ðŸ”Ž Bestand prÃ¼fen</h3>
<select id="searchFood"></select>
<button onclick="checkStock()">Bestand prÃ¼fen</button>
<p id="stockResult"></p>
</div>

<!-- Neues Lebensmittel -->
<div class="section">
<h3>âž• Neues Lebensmittel</h3>
<input type="text" id="foodName" placeholder="Name">
<input type="number" id="amountPerUnit" placeholder="Menge pro Einheit">
<select id="unitSelect"></select>
<select id="categorySelect"></select>
<button onclick="addFood()">Speichern</button>
</div>

<!-- Einkauf -->
<div class="section">
<h3>ðŸ›’ Einkauf</h3>
<select id="purchaseFood"></select>
<select id="purchaseShop"></select>
<input type="number" id="purchaseQuantity" placeholder="Menge">
<input type="number" id="purchasePrice" placeholder="Preis pro Einheit (â‚¬)">
<input type="date" id="purchaseDate">
<label>
<input type="checkbox" id="selfPaid" checked> Selbst bezahlt
</label>
<button onclick="addPurchase()">Speichern</button>
</div>

<!-- Verbrauch -->
<div class="section">
<h3>âž– Verbrauch</h3>
<select id="consumeFood"></select>
<input type="number" id="consumeQuantity" placeholder="Menge">
<button onclick="addConsumption()">Speichern</button>
</div>

<!-- EinkÃ¤ufe -->
<div class="section">
<h3>ðŸ“‹ Alle EinkÃ¤ufe</h3>
<table id="purchaseTable"></table>
</div>

<!-- VerbrÃ¤uche -->
<div class="section">
<h3>ðŸ“‹ Alle VerbrÃ¤uche</h3>
<table id="consumptionTable"></table>
</div>

<script>

const supabaseClient = window.supabase.createClient(
  "https://rynahngmkossspauuuzf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bmFobmdta29zc3NwYXV1dXpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTI3NjksImV4cCI6MjA4NjIyODc2OX0.AhVlHxcT1NTzpU7QxQRjXULJPAcnDN9fmLB1ygeGbH0"
);

/* ===========================
   DROPDOWNS
=========================== */

async function loadDropdowns() {

  const { data: foods } = await supabaseClient.from("foods").select("id,name").order("name");
  const { data: shops } = await supabaseClient.from("shops").select("id,shop").order("shop");
  const { data: units } = await supabaseClient.from("units").select("id,unit").order("unit");
  const { data: categories } = await supabaseClient.from("category").select("id,category").order("category");

  fillSelect("searchFood", foods, "name");
  fillSelect("purchaseFood", foods, "name");
  fillSelect("consumeFood", foods, "name");

  fillSelect("purchaseShop", shops, "shop");
  fillSelect("unitSelect", units, "unit");
  fillSelect("categorySelect", categories, "category");
}

function fillSelect(id, data, field) {
  const select = document.getElementById(id);
  if (!select || !data) return;
  select.innerHTML = "";
  data.forEach(item => {
    const option = document.createElement("option");
    option.value = item.id;
    option.textContent = item[field];
    select.appendChild(option);
  });
}

/* ===========================
   NEUES LEBENSMITTEL
=========================== */

async function addFood() {
  await supabaseClient.from("foods").insert([{
    name: document.getElementById("foodName").value,
    amount_per_unit: Number(document.getElementById("amountPerUnit").value),
    unit_food: Number(document.getElementById("unitSelect").value),
    category: Number(document.getElementById("categorySelect").value)
  }]);
  alert("Lebensmittel gespeichert");
  loadDropdowns();
}

/* ===========================
   EINKAUF
=========================== */

async function addPurchase() {
  await supabaseClient.from("purchases").insert([{
    food_id: Number(document.getElementById("purchaseFood").value),
    shop: Number(document.getElementById("purchaseShop").value),
    quantity: Number(document.getElementById("purchaseQuantity").value),
    price_per_unit: Number(document.getElementById("purchasePrice").value),
    purchased_at: document.getElementById("purchaseDate").value,
    self_paid: document.getElementById("selfPaid").checked
  }]);
  alert("Einkauf gespeichert");
  loadPurchases();
}

/* ===========================
   VERBRAUCH
=========================== */

async function addConsumption() {
  await supabaseClient.from("consumptions").insert([{
    food_id: Number(document.getElementById("consumeFood").value),
    quantity: Number(document.getElementById("consumeQuantity").value),
    consumed_at: new Date()
  }]);
  alert("Verbrauch gespeichert");
  loadConsumptions();
}

/* ===========================
   BESTAND
=========================== */

async function checkStock() {

  const foodId = Number(document.getElementById("searchFood").value);

  const { data: food } = await supabaseClient
    .from("foods")
    .select("amount_per_unit, units(unit)")
    .eq("id", foodId)
    .single();

  const { data: purchases } = await supabaseClient
    .from("purchases")
    .select("quantity")
    .eq("food_id", foodId);

  const { data: consumptions } = await supabaseClient
    .from("consumptions")
    .select("quantity")
    .eq("food_id", foodId);

  const bought = purchases?.reduce((s,p)=>s+Number(p.quantity),0) || 0;
  const used = consumptions?.reduce((s,c)=>s+Number(c.quantity),0) || 0;

  const remainingUnits = bought - used;
  const exactAmount = remainingUnits * food.amount_per_unit;

  document.getElementById("stockResult").innerText =
    remainingUnits > 0
      ? `Bestand: ${remainingUnits} Einheiten = ${exactAmount} ${food.units.unit}`
      : "Kein Bestand";
}

/* ===========================
   LISTEN
=========================== */

async function loadPurchases() {

  const { data } = await supabaseClient
    .from("purchases")
    .select("quantity, price_per_unit, purchased_at, foods(name), shops(shop)")
    .order("purchased_at", { ascending:false });

  const table = document.getElementById("purchaseTable");
  table.innerHTML = "<tr><th>Lebensmittel</th><th>Shop</th><th>Menge</th><th>Preis</th><th>Datum</th></tr>";

  if (!data) return;

  data.forEach(row => {
    table.innerHTML += `
      <tr>
        <td>${row.foods?.name || ""}</td>
        <td>${row.shops?.shop || ""}</td>
        <td>${row.quantity}</td>
        <td>${row.price_per_unit}</td>
        <td>${row.purchased_at}</td>
      </tr>`;
  });
}

async function loadConsumptions() {

  const { data } = await supabaseClient
    .from("consumptions")
    .select("quantity, consumed_at, foods(name)")
    .order("consumed_at", { ascending:false });

  const table = document.getElementById("consumptionTable");
  table.innerHTML = "<tr><th>Lebensmittel</th><th>Menge</th><th>Datum</th></tr>";

  if (!data) return;

  data.forEach(row => {
    table.innerHTML += `
      <tr>
        <td>${row.foods?.name || ""}</td>
        <td>${row.quantity}</td>
        <td>${row.consumed_at}</td>
      </tr>`;
  });
}

/* =========================== */

loadDropdowns();
loadPurchases();
loadConsumptions();

</script>

</body>
</html>
