<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Lebensmittel â€“ Verwaltung</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: sans-serif; padding: 2rem; }
section {
  margin-bottom: 2rem;
  padding: 1rem;
  border: 1px solid #ddd;
  border-radius: 8px;
  max-width: 900px;
}
input, select, button {
  padding: 0.5rem;
  margin: 0.5rem 0.5rem 0 0;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
th, td {
  border: 1px solid #ddd;
  padding: 0.5rem;
  text-align: left;
}
th { background: #f2f2f2; }
canvas { max-width: 900px; margin-top: 2rem; }
</style>
</head>

<body>

<h1>ðŸ“Š Lebensmittel â€“ Verwaltung</h1>

<!-- ðŸ†• FOOD -->
<section>
<h2>âž• Neues Lebensmittel hinzufÃ¼gen</h2>
<input id="foodName" placeholder="Name" />
<input type="number" id="foodAmount" placeholder="Menge pro Einheit" />
<input id="foodUnit" placeholder="Einheit (z.B. g, ml)" />
<select id="foodCategory"></select>
<select id="foodShop"></select>
<button onclick="addFood()">Speichern</button>
</section>

<!-- ðŸ›’ PURCHASE -->
<section>
<h2>ðŸ›’ Einkauf hinzufÃ¼gen</h2>
<select id="purchaseFood"></select>
<input type="number" id="purchaseQuantity" placeholder="Menge" step="0.01" />
<input type="number" id="purchasePrice" placeholder="Preis pro Einheit (â‚¬)" step="0.01" />
<input type="date" id="purchaseDate" />
<label>
<input type="checkbox" id="selfPaid" checked /> Selbst bezahlt
</label>
<button onclick="addPurchase()">Speichern</button>

<h3>ðŸ“‹ Alle EinkÃ¤ufe</h3>
<table>
<thead>
<tr>
<th>Datum</th>
<th>Produkt</th>
<th>Menge</th>
<th>Preis</th>
<th>Selbst bezahlt</th>
</tr>
</thead>
<tbody id="purchaseTable"></tbody>
</table>
</section>

<!-- âž– CONSUMPTION -->
<section>
<h2>âž– Verbrauch hinzufÃ¼gen</h2>
<select id="consumeFood"></select>
<input type="number" id="consumeQuantity" placeholder="Menge" step="0.01" />
<button onclick="addConsumption()">Speichern</button>

<h3>ðŸ“‹ Alle VerbrÃ¤uche</h3>
<table>
<thead>
<tr>
<th>Datum</th>
<th>Produkt</th>
<th>Menge</th>
</tr>
</thead>
<tbody id="consumptionTable"></tbody>
</table>
</section>

<canvas id="chart"></canvas>

<script>
const SUPABASE_URL = "https://rynahngmkossspauuuzf.supabase.co";
const SUPABASE_KEY = "sb_publishable_RABcAIZj67OoVSa53tGn_g_iklm-iCO";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

let chartInstance = null;

/* ================= LOAD ================= */

async function loadCategories() {
  const { data } = await supabaseClient.from("category").select("*").order("category");
  const select = document.getElementById("foodCategory");
  select.innerHTML = "";
  data?.forEach(c => {
    select.innerHTML += `<option value="${c.id}">${c.category}</option>`;
  });
}

async function loadShops() {
  const { data } = await supabaseClient.from("shops").select("*").order("shop");
  const select = document.getElementById("foodShop");
  select.innerHTML = "";
  data?.forEach(s => {
    select.innerHTML += `<option value="${s.id}">${s.shop}</option>`;
  });
}

async function loadFoods() {
  const { data } = await supabaseClient.from("foods").select("*").order("name");
  const purchase = document.getElementById("purchaseFood");
  const consume = document.getElementById("consumeFood");
  purchase.innerHTML = "";
  consume.innerHTML = "";
  data?.forEach(f => {
    purchase.innerHTML += `<option value="${f.id}">${f.name}</option>`;
    consume.innerHTML += `<option value="${f.id}">${f.name}</option>`;
  });
}

/* ================= INSERT ================= */

async function addFood() {
  const name = foodName.value;
  const amount = foodAmount.value;
  const unit = foodUnit.value;
  const category = foodCategory.value;
  const shop = foodShop.value;

  await supabaseClient.from("foods").insert([{
    name,
    amount_per_unit: Number(amount),
    unit,
    category: Number(category),
    shop: Number(shop)
  }]);

  alert("Gespeichert");
  loadFoods();
}

async function addPurchase() {
  await supabaseClient.from("purchases").insert([{
    food_id: Number(purchaseFood.value),
    quantity: Number(purchaseQuantity.value),
    price_per_unit: Number(purchasePrice.value),
    purchased_at: purchaseDate.value || new Date(),
    self_paid: selfPaid.checked
  }]);

  alert("Einkauf gespeichert");
  loadPurchases();
  loadData();
}

async function addConsumption() {
  await supabaseClient.from("consumptions").insert([{
    food_id: Number(consumeFood.value),
    quantity: Number(consumeQuantity.value),
    consumed_at: new Date()
  }]);

  alert("Verbrauch gespeichert");
  loadConsumptions();
  loadData();
}

/* ================= TABLE LISTS ================= */

async function loadPurchases() {
  const { data } = await supabaseClient
    .from("purchases")
    .select("purchased_at, quantity, price_per_unit, self_paid, foods(name)")
    .order("purchased_at", { ascending: false });

  const table = document.getElementById("purchaseTable");
  table.innerHTML = "";

  data?.forEach(p => {
    table.innerHTML += `
      <tr>
        <td>${p.purchased_at ? p.purchased_at.split("T")[0] : ""}</td>
        <td>${p.foods?.name || ""}</td>
        <td>${p.quantity}</td>
        <td>${p.price_per_unit} â‚¬</td>
        <td>${p.self_paid ? "Ja" : "Nein"}</td>
      </tr>`;
  });
}

async function loadConsumptions() {
  const { data } = await supabaseClient
    .from("consumptions")
    .select("consumed_at, quantity, foods(name)")
    .order("consumed_at", { ascending: false });

  const table = document.getElementById("consumptionTable");
  table.innerHTML = "";

  data?.forEach(c => {
    table.innerHTML += `
      <tr>
        <td>${c.consumed_at ? c.consumed_at.split("T")[0] : ""}</td>
        <td>${c.foods?.name || ""}</td>
        <td>${c.quantity}</td>
      </tr>`;
  });
}

/* ================= CHART ================= */

async function loadData() {
  const { data } = await supabaseClient
    .from("food_costs")
    .select("food_name, total_amount")
    .order("food_name");

  if (!data) return;

  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(document.getElementById("chart"), {
    type: "bar",
    data: {
      labels: data.map(d => d.food_name),
      datasets: [{
        label: "Kosten (â‚¬)",
        data: data.map(d => d.total_amount)
      }]
    }
  });
}

/* ================= INIT ================= */

loadCategories();
loadShops();
loadFoods();
loadPurchases();
loadConsumptions();
loadData();

</script>
</body>
</html>
