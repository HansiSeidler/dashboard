<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Lebensmittel Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: sans-serif; padding: 2rem; }
    h1 { margin-bottom: 1rem; }

    section {
      margin-bottom: 2rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-width: 600px;
    }

    input, select, button {
      padding: 0.5rem;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }

    canvas { max-width: 700px; margin-top: 2rem; }
  </style>
</head>

<body>

<h1>ðŸ“Š Lebensmittel â€“ Kosten</h1>

<!-- âž• Einkauf -->
<section>
  <h2>âž• Einkauf hinzufÃ¼gen</h2>
  <select id="purchaseFood"></select>
  <input type="number" id="purchaseQuantity" placeholder="Menge" step="0.01" />
  <input type="number" id="purchasePrice" placeholder="Preis pro Einheit (â‚¬)" step="0.01" />
  <button onclick="addPurchase()">Speichern</button>
</section>

<!-- âž– Verbrauch -->
<section>
  <h2>âž– Verbrauch hinzufÃ¼gen</h2>
  <select id="consumeFood"></select>
  <input type="number" id="consumeQuantity" placeholder="Menge" step="0.01" />
  <button onclick="addConsumption()">Speichern</button>
</section>

<canvas id="chart"></canvas>

<script>
  const SUPABASE_URL = "https://rynahngmkossspauuuzf.supabase.co";
  const SUPABASE_KEY = "sb_publishable_RABcAIZj67OoVSa53tGn_g_iklm-iCO";

  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  let chartInstance = null;

  // ðŸ”¹ Lebensmittel laden
  async function loadFoods() {
    const { data, error } = await supabaseClient
      .from("foods")
      .select("id, name")
      .order("name");

    if (error) {
      console.error(error);
      return;
    }

    const purchaseSelect = document.getElementById("purchaseFood");
    const consumeSelect = document.getElementById("consumeFood");

    purchaseSelect.innerHTML = "";
    consumeSelect.innerHTML = "";

    data.forEach(food => {
      const option1 = document.createElement("option");
      option1.value = food.id;
      option1.textContent = food.name;

      const option2 = option1.cloneNode(true);

      purchaseSelect.appendChild(option1);
      consumeSelect.appendChild(option2);
    });
  }

  // ðŸ”¹ Chart laden
  async function loadData() {
    const { data, error } = await supabaseClient
      .from("food_costs")
      .select("food_name, total_amount")
      .order("food_name");

    if (error) {
      console.error(error);
      alert("Fehler beim Laden der Daten");
      return;
    }

    const labels = data.map(d => d.food_name);
    const values = data.map(d => d.total_amount);

    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(document.getElementById("chart"), {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Kosten (â‚¬)",
          data: values
        }]
      }
    });
  }

  // ðŸ”¹ Einkauf speichern
  async function addPurchase() {
    const foodId = document.getElementById("purchaseFood").value;
    const quantity = document.getElementById("purchaseQuantity").value;
    const price = document.getElementById("purchasePrice").value;

    if (!quantity || !price) {
      alert("Bitte Menge und Preis eingeben");
      return;
    }

    const { error } = await supabaseClient
      .from("purchases")
      .insert([
        {
          food_id: Number(foodId),
          quantity: Number(quantity),
          price_per_unit: Number(price),
          purchased_at: new Date()
        }
      ]);

    if (error) {
      alert("Fehler beim Speichern");
      console.error(error);
    } else {
      alert("Einkauf gespeichert");

      document.getElementById("purchaseQuantity").value = "";
      document.getElementById("purchasePrice").value = "";

      loadData();
    }
  }

  // ðŸ”¹ Verbrauch speichern
  async function addConsumption() {
    const foodId = document.getElementById("consumeFood").value;
    const quantity = document.getElementById("consumeQuantity").value;

    if (!quantity) {
      alert("Bitte Menge eingeben");
      return;
    }

    const { error } = await supabaseClient
      .from("consumptions")
      .insert([
        {
          food_id: Number(foodId),
          quantity: Number(quantity),
          consumed_at: new Date()
        }
      ]);

    if (error) {
      alert("Fehler beim Speichern");
      console.error(error);
    } else {
      alert("Verbrauch gespeichert");

      document.getElementById("consumeQuantity").value = "";

      loadData();
    }
  }

  // ðŸ”¹ Initial laden
  loadFoods();
  loadData();
</script>

</body>
</html>

